<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Tabella Certificati Finanziari</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 10px;
      background: #fff;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 1.2rem;
    }
    table.dataTable tbody tr.hovered {
      background-color: #f8f9fa !important;
    }
    table.dataTable {
      border-collapse: collapse !important;
    }
    table.dataTable td, table.dataTable th {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
      font-size: 10px;
      background-color: white !important;
    }
    .row-top-divider td {
      border-top: 2px solid #999 !important;
    }
    .positive {
      color: green;
      font-weight: bold;
    }
    .negative {
      color: red;
      font-weight: bold;
    }
    .isin-link {
      color: #003366;
      font-weight: bold;
      text-decoration: none;
    }
    .isin-link:hover {
      text-decoration: underline;
    }
    .cert-counter {
      font-size: 10px;
      margin: 10px 0;
      color: #6c757d;
    }
    .cert-counter strong {
      color: #212529;
      font-weight: 600;
    }
    .dataTables_length, .dataTables_info {
      display: none;
    }
    #custom-search {
      margin-bottom: 10px;
      font-size: 10px;
      padding: 5px;
      width: 250px;
    }
  </style>
</head>
<body>

<h1>Tabella Certificati Finanziari</h1>
<input type="text" id="custom-search" placeholder="Cerca...">
<div class="cert-counter" id="cert-counter"></div>
<table id="certTable" class="display" style="width:100%">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWK_CUJUV8yI0jG51rgpz7DMcVTuLt_HqjyTLPdPDkTyIxWBn8G6yozBtVU3bVymtwOCeZPCKmNAsW/pub?output=csv";

let allData = [];
let table;

function updateCounter() {
  const visibleISIN = new Set();
  table.rows({search: 'applied'}).every(function() {
    const isin = $(this.node()).find('td:last-child a').text().trim();
    visibleISIN.add(isin);
  });
  const total = new Set(allData.map(d => $(d[d.length-1]).text().trim())).size;
  document.getElementById("cert-counter").innerHTML = `Certificati mostrati <strong>${visibleISIN.size}</strong> su <strong>${total}</strong>`;
}

function addDividers() {
  const rows = $('#certTable tbody tr');
  let prevISIN = null;
  rows.each(function() {
    const isin = $(this).find('td:last-child a').text().trim();
    if (isin !== prevISIN) {
      $(this).addClass('row-top-divider');
      prevISIN = isin;
    }
  });
}

fetch(csvUrl)
  .then(res => res.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
    const rawData = parsed.data.filter(row => Object.values(row)[1]?.trim() !== "----------");

    const headers = Object.keys(rawData[0]).filter(h => 
      h !== "Effetto memoria" &&
      h !== "Tipologia di barriera" &&
      h !== "Quanto (protezione cambio)" &&
      h !== "Osservazione" &&
      h !== "Link"
    );

    const thead = document.querySelector("#certTable thead");
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.innerText = h;
      tr.appendChild(th);
    });
    thead.appendChild(tr);

    rawData.forEach(row => {
      if ((row["Quanto (protezione cambio)"] || "").trim().toLowerCase() === "s√¨") {
        row["Valuta"] = `${row["Valuta"]}<div>Quanto</div>`;
      }

      if (row["Osservazione"] && row["Prossima Osservazione"]) {
        row["Prossima Osservazione"] = `${row["Prossima Osservazione"]}<div>${row["Osservazione"]}</div>`;
      }

      if (row["Tipologia di barriera"]?.toLowerCase().includes("solo a scadenza")) {
        row["Barriera capitale"] = `${row["Barriera capitale"]}<div>Europea</div>`;
      }

      const mem = row["Effetto memoria"];
      if (mem?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() === "si") {
        row["Barriera cedolare"] = `${row["Barriera cedolare"]}<div>Si Memory</div>`;
      }

      const formattedRow = headers.map(h => {
        const val = row[h] || "";
        if (h.toLowerCase() === "performance") {
          const num = parseFloat(val.replace('%', '').replace(',', '.'));
          if (!isNaN(num)) {
            const cls = num >= 0 ? 'positive' : 'negative';
            return `<span class="${cls}">${val}</span>`;
          }
        }
        if (h === "ISIN" && val.startsWith("CH")) {
          const link = row["Link"]?.trim();
          return `<a class="isin-link" href="${link}" target="_blank">${val}</a>`;
        }
        if (val.includes("<div>")) return val;
        return val;
      });
      allData.push(formattedRow);
    });

    table = $('#certTable').DataTable({
      data: allData,
      columns: headers.map(h => ({ title: h })),
      ordering: false,
      paging: true,
      pageLength: 30,
      searching: true,
      language: {
        paginate: {
          previous: 'Precedente',
          next: 'Successivo'
        }
      },
      initComplete: function() {
        updateCounter();
        addDividers();
      }
    });

    $('#certTable tbody').on('mouseenter', 'tr', function () {
      const isinCell = $(this).find('td:last-child a').text().trim();
      $('#certTable tbody tr').each(function() {
        if ($(this).find('td:last-child a').text().trim() === isinCell) {
          $(this).addClass('hovered');
        }
      });
    });

    $('#certTable tbody').on('mouseleave', 'tr', function () {
      $('#certTable tbody tr').removeClass('hovered');
    });

    $('#custom-search').on('keyup', function() {
      table.search(this.value).draw();
      updateCounter();
      addDividers();
    });

    table.on('draw', function() {
      updateCounter();
      addDividers();
    });

    $.fn.dataTable.ext.search.push(
      function(settings, data, dataIndex) {
        const searchTerm = $('#custom-search').val().toLowerCase();
        if (!searchTerm) return true;
        const isin = $(table.row(dataIndex).node()).find('td:last-child a').text().toLowerCase();
        return isin.includes(searchTerm);
      }
    );
  });
</script>

</body>
</html>

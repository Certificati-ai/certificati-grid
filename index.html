<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Tabella Certificati Finanziari</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: 10px;
      background: #fff;
      padding: 20px;
    }
    h1 {
      text-align: center;
      font-size: 1.2rem;
    }
    .dataTables_wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .dataTables_filter {
      order: -1;
      align-self: flex-start;
      margin-bottom: 10px;
    }
    .dataTables_filter label {
      font-size: 10px;
      font-weight: bold;
    }
    .dataTables_filter label::before {
      content: "";
    }
    .dataTables_filter label > input {
      margin-left: 0;
    }
    .dataTables_filter input {
      font-size: 10px;
      padding: 5px;
    }
    table.dataTable {
      border-collapse: collapse !important;
    }
    table.dataTable td, table.dataTable th {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
      font-size: 10px;
      background-color: white !important;
    }
    table.dataTable tbody tr.hovered {
      background-color: #f1f3f5 !important;
    }
    .row-top-divider td {
      border-top: 2px solid #333 !important;
    }
    .positive {
      color: green;
      font-weight: bold;
    }
    .negative {
      color: red;
      font-weight: bold;
    }
    .isin-link {
      color: #003366;
      font-weight: bold;
      text-decoration: none;
    }
    .isin-link:hover {
      text-decoration: underline;
    }
    .cert-counter {
      font-size: 10px;
      margin: 10px 0;
      color: #6c757d;
    }
    .cert-counter strong {
      color: #212529;
      font-weight: 600;
    }
    .dataTables_length, .dataTables_info {
      display: none;
    }
  </style>
</head>
<body>

<h1>Tabella Certificati Finanziari</h1>
<div id="certTable_wrapper">
  <div id="cert-counter" class="cert-counter"></div>
  <table id="certTable" class="display" style="width:100%">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWK_CUJUV8yI0jG51rgpz7DMcVTuLt_HqjyTLPdPDkTyIxWBn8G6yozBtVU3bVymtwOCeZPCKmNAsW/pub?output=csv";

let table;
let blockCounter = 0;
const allData = [];

function updateCounter() {
  const visibleBlocks = new Set();
  table.rows({ search: 'applied' }).every(function() {
    const blockId = $(this.node()).attr('data-block-id');
    if (blockId) {
      visibleBlocks.add(blockId);
    }
  });
  const total = new Set(allData.map(d => d.blockId)).size;
  document.getElementById("cert-counter").innerHTML = `Certificati mostrati <strong>${visibleBlocks.size}</strong> su <strong>${total}</strong>`;
}

fetch(csvUrl)
  .then(res => res.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
    const rawData = parsed.data.filter(row => Object.values(row)[1]?.trim() !== "----------");

    const headers = Object.keys(rawData[0]).filter(h => 
      h !== "Effetto memoria" &&
      h !== "Tipologia di barriera" &&
      h !== "Quanto (protezione cambio)" &&
      h !== "Osservazione" &&
      h !== "Link"
    );

    const thead = document.querySelector("#certTable thead");
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const th = document.createElement("th");
      th.innerText = h;
      tr.appendChild(th);
    });
    thead.appendChild(tr);

    rawData.forEach(row => {
      if ((row["Quanto (protezione cambio)"] || "").trim().toLowerCase() === "s√¨") {
        row["Valuta"] = `${row["Valuta"]}<div>Quanto</div>`;
      }

      if (row["Osservazione"] && row["Prossima Osservazione"]) {
        row["Prossima Osservazione"] = `${row["Prossima Osservazione"]}<div>${row["Osservazione"]}</div>`;
      }

      if (row["Tipologia di barriera"]?.toLowerCase().includes("solo a scadenza")) {
        row["Barriera capitale"] = `${row["Barriera capitale"]}<div>Europea</div>`;
      }

      const mem = row["Effetto memoria"];
      if (mem?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() === "si") {
        row["Barriera cedolare"] = `${row["Barriera cedolare"]}<div>Si Memory</div>`;
      }

      const formattedRow = headers.map(h => {
        const val = row[h] || "";
        const safeVal = val.replace(/"/g, '&quot;'); // sicurezza
        if (h.toLowerCase() === "performance") {
          const num = parseFloat(val.replace('%', '').replace(',', '.'));
          if (!isNaN(num)) {
            const cls = num >= 0 ? 'positive' : 'negative';
            return `<span class="${cls}" title="${safeVal}">${val}</span>`;
          }
        }
        if (h === "ISIN" && val.startsWith("CH")) {
          const link = row["Link"]?.trim();
          return `<a class="isin-link" href="${link}" target="_blank" title="${safeVal}">${val}</a>`;
        }
        return `<div title="${safeVal}">${val}</div>`;
      });

      if (row["ISIN"]?.startsWith("CH")) {
        blockCounter++;
      }
      allData.push({ data: formattedRow, blockId: blockCounter });
    });

    table = $('#certTable').DataTable({
      data: allData.map(d => d.data),
      columns: headers.map(h => ({ title: h })),
      ordering: false,
      paging: true,
      pageLength: 30,
      searching: true,
      language: {
        search: "",
        searchPlaceholder: "Cerca...",
        paginate: {
          previous: 'Precedente',
          next: 'Successivo'
        }
      },
      createdRow: function(row, data, dataIndex) {
        const blockId = allData[dataIndex].blockId;
        $(row).attr('data-block-id', blockId);
        if (data[headers.indexOf('ISIN')].includes('isin-link')) {
          $(row).addClass('row-top-divider');
        }
      },
      initComplete: function() {
        updateCounter();
      }
    });

    // Hover su tutto il blocco
    $('#certTable tbody').on('mouseenter', 'tr', function () {
      const blockId = $(this).attr('data-block-id');
      const nodes = table.rows().nodes(); // tutti i nodi, non solo current page
      $(nodes).each(function() {
        if ($(this).attr('data-block-id') === blockId) {
          $(this).addClass('hovered');
        }
      });
    });

    $('#certTable tbody').on('mouseleave', 'tr', function () {
      const nodes = table.rows().nodes();
      $(nodes).removeClass('hovered');
    });

    // Custom search per blocco
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
      const searchTerm = $('.dataTables_filter input').val().toLowerCase();
      if (!searchTerm) return true;

      const node = table.row(dataIndex).node();
      const blockId = $(node).attr('data-block-id');

      const nodes = table.rows().nodes();
      let blockHasMatch = false;

      $(nodes).each(function() {
        if ($(this).attr('data-block-id') === blockId) {
          const text = $(this).text().toLowerCase();
          if (text.includes(searchTerm)) {
            blockHasMatch = true;
          }
        }
      });

      return blockHasMatch;
    });

    $('.dataTables_filter input').on('keyup', function() {
      table.draw();
      updateCounter();
    });

    table.on('draw', function() {
      updateCounter();
    });
  });
</script>

</body>
</html>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWK_CUJUV8yI0jG51rgpz7DMcVTuLt_HqjyTLPdPDkTyIxWBn8G6yozBtVU3bVymtwOCeZPCKmNAsW/pub?output=csv";

fetch(csvUrl)
  .then(res => res.text())
  .then(csv => {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
    const raw = parsed.data.filter(row => Object.values(row)[1]?.trim() !== "----------");

    const allISINs = new Set();
    const headers = Object.keys(raw[0]).filter(h =>
      h !== "Effetto memoria" &&
      h !== "Tipologia di barriera" &&
      h !== "Quanto (protezione cambio)" &&
      h !== "Osservazione" &&
      h !== "Link"
    );

    const data = [];

    for (const row of raw) {
      const currISIN = row["ISIN"];
      if (currISIN) allISINs.add(currISIN);

      if ((row["Quanto (protezione cambio)"] || "").trim().toLowerCase() === "s√¨") {
        row["Valuta"] = `${row["Valuta"]}<div>Quanto</div>`;
      }

      if (row["Osservazione"] && row["Prossima Osservazione"]) {
        row["Prossima Osservazione"] = `${row["Prossima Osservazione"]}<div>${row["Osservazione"]}</div>`;
      }

      if (row["Tipologia di barriera"]?.toLowerCase().includes("solo a scadenza")) {
        row["Barriera capitale"] = `${row["Barriera capitale"]}<div>Europea</div>`;
      }

      const mem = row["Effetto memoria"];
      if (mem?.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() === "si") {
        row["Barriera cedolare"] = `${row["Barriera cedolare"]}<div>Si Memory</div>`;
      }

      const formattedRow = headers.map(h => {
        const val = row[h] || "";

        if (h.toLowerCase() === "performance") {
          const num = parseFloat(val.replace('%', '').replace(',', '.'));
          if (!isNaN(num)) {
            const cls = num >= 0 ? 'positive' : 'negative';
            return gridjs.html(`<span class="${cls}">${val}</span>`);
          }
        }

        if (h === "ISIN" && val.startsWith("CH")) {
          const link = row["Link"]?.trim();
          return gridjs.html(`<a class="isin-link" href="${link}" target="_blank">${val}</a>`);
        }

        if (val.includes("<div>")) return gridjs.html(val);
        return val;
      });

      data.push({ row: formattedRow, isin: currISIN });
    }

    const grid = new gridjs.Grid({
      columns: headers,
      data: data.map(d => d.row),
      search: {
        enabled: true,
        placeholder: "Cerca..."
      },
      sort: true,
      pagination: {
        enabled: true,
        limit: 30
      },
      language: {
        search: { placeholder: "Cerca..." },
        pagination: {
          previous: 'Precedente',
          next: 'Successivo',
          loading: 'Caricamento...'
        }
      }
    }).render(document.getElementById("table"));

    // üí• QUI IL SETTIMEOUT 800ms
    setTimeout(() => {
      const rows = document.querySelectorAll(".gridjs-table tbody tr");
      const visibleISINs = new Set();
      let prev = null;

      rows.forEach((tr, i) => {
        const isinCell = tr.querySelector("td:last-child a");
        const currISIN = isinCell?.textContent.trim();

        if (currISIN) visibleISINs.add(currISIN);

        if (currISIN && currISIN !== prev) {
          tr.classList.add("row-top-divider");
          if (i > 0) rows[i - 1].classList.add("row-bottom-divider");
          prev = currISIN;
        }

        // Hover su tutte le righe stesso ISIN
        tr.addEventListener('mouseenter', () => {
          rows.forEach(r => {
            const rIsin = r.querySelector("td:last-child a")?.textContent.trim();
            if (rIsin === currISIN) {
              r.style.backgroundColor = "#f8f9fa";
            }
          });
        });

        tr.addEventListener('mouseleave', () => {
          rows.forEach(r => {
            r.style.backgroundColor = "";
          });
        });
      });

      // Nasconde il messaggio "Showing 1 to 12 of 12 results"
      const summary = document.querySelector(".gridjs-summary");
      if (summary) summary.remove();

      // Aggiunge il contatore "Certificati mostrati x su y"
      const pagination = document.querySelector(".gridjs-pagination");
      if (pagination) {
        const countDiv = document.createElement("div");
        countDiv.className = "cert-counter";
        countDiv.innerHTML = `Certificati mostrati <strong>${visibleISINs.size}</strong> su <strong>${allISINs.size}</strong>`;
        pagination.parentNode.insertBefore(countDiv, pagination);
      }
    }, 800);
  });
</script>

